/*
**************************************************************************
 sgcWebSocket component

 written by eSeGeCe
            copyright © 2013
            Email : info@esegece.com
            Web : http://www.esegece.com
**************************************************************************
*/
function sgcws_webrtc(){var G;var n;var K;var m;var w;var o;var u={mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true}};var s=false;var b=false;self=this;if(arguments.length==0){return}if(arguments.length==1){if(typeof arguments[0]=="object"){arguments[0]["subprotocol"]="webrtc.esegece.com";sgcWebSocket.call(this,arguments)}else{if(typeof arguments[0]=="string"){arguments[1]="webrtc.esegece.com";sgcWebSocket.call(this,arguments[0],arguments[1])}}}else{if(arguments.length==2){if(typeof arguments[0]=="object"){arguments[0]["subprotocol"]=arguments[1]+".webrtc.esegece.com";sgcWebSocket.call(this,arguments)}else{if(typeof arguments[0]=="string"){arguments[1]=arguments[1]+".webrtc.esegece.com";sgcWebSocket.call(this,arguments[0],arguments[1])}}}}var l=this.send;this.send=function(Y,aa,X,Z){if(arguments.length==1){arguments[0]='{"jsonrpc":"2.0", "method":"sgc@message", "params":{"message":"'+Y+'"}, "id":"'+GUID()+'", "webrtc":""}'}else{if(arguments.length==2){arguments[0]='{"jsonrpc":"2.0", "method":"'+aa+'", "params":{"message":"'+Y+'"}, "id":"'+GUID()+'", "webrtc":""}'}else{if((Z!=="")&&(Z!==undefined)){arguments[0]='{"jsonrpc":"2.0", "method":"'+aa+'", "params":{"channel":"'+X+'", "message":"'+Y+'"}, "id":"'+Z+'", "webrtc":""}'}else{arguments[0]='{"jsonrpc":"2.0", "method":"'+aa+'", "params":{"channel":"'+X+'", "message":"'+Y+'"}, "webrtc":""}'}}}l.apply(this,arguments)};var p=this.close;this.close=function(){H(o,{type:"bye"});p.apply(this,arguments)};function H(Y,X){var Z=JSON.stringify(X);arguments[0]='{"jsonrpc":"2.0", "method":"sgc@webrtc", "params":{"channel":"'+Y+'", "message":""}, "webrtc":'+Z+"}";l.apply(self,arguments)}this.broadcast=function(){if(arguments.length==1){this.send(arguments[0],"sgc@broadcast","")}else{if(arguments.length==2){this.send(arguments[0],"sgc@broadcast",arguments[1])}}};function C(){b=false;s=false;w.close();w=null;I()}this.webrtc_connect=function(X){o=X;this.send("","sgc@subscribe",X)};this.webrtc_disconnect=function(X){o=X;this.send("","sgc@unsubscribe",X);C()};function h(X,Y){X.src=webkitURL.createObjectURL(Y)}function q(){var X={iceServers:[{url:"stun:stun.l.google.com:19302"}]};try{RTCPeerConnection=webkitRTCPeerConnection||mozRTCPeerConnection;w=new RTCPeerConnection(X);w.onicecandidate=R}catch(Y){alert("Cannot create RTCPeerConnection object; WebRTC is not supported by this browser.");return}w.onconnecting=U;w.onopen=v;w.onaddstream=r;w.onremovestream=t}function j(){w.createOffer(x,null,u)}function Q(){w.createAnswer(x,null,u)}function x(X){X.sdp=V(X.sdp);w.setLocalDescription(X);H(o,X)}function k(Y){var Z=JSON.parse(Y);if(Z.type==="offer"){w.setRemoteDescription(new RTCSessionDescription(Z));Q()}else{if(Z.type==="answer"){w.setRemoteDescription(new RTCSessionDescription(Z))}else{if(Z.type==="candidate"){var X=new RTCIceCandidate({sdpMLineIndex:Z.label,candidate:Z.candidate});w.addIceCandidate(X)}else{if(Z.type==="bye"){d()}}}}}function R(X){if(X.candidate){H(o,{type:"candidate",label:X.candidate.sdpMLineIndex,id:X.candidate.sdpMid,candidate:X.candidate.candidate})}else{}}function U(X){y.fire({name:"onsgsessionconnecting",message:X})}function v(X){c.fire({name:"onsgsessionopen",message:X})}function I(){e.fire({name:"onsgsessionclose"})}function r(X){O.fire({name:"onsgcaddstream",stream:X.stream});h(n,X.stream);m=X.stream;S()}function t(X){T.fire({name:"onsgcremovestream"})}function A(){P();C();this.close()}function d(){N();C()}function S(){if(m.videoTracks.length===0||n.currentTime>0){i()}else{setTimeout(S,100)}}function i(){n.style.opacity=1;setTimeout(function(){localVideo.style.opacity=1},1000)}function N(){setTimeout(function(){n.src=""},500);localVideo.style.opacity=0;n.style.opacity=0}function P(){localVideo.style.opacity=0;n.style.opacity=0}window.onbeforeunload=function(){H(o,{type:"bye"})};function V(X){var aa=X.split("\r\n");for(var Z=0;Z<aa.length;Z++){if(aa[Z].search("m=audio")!==-1){var ab=Z;break}}if(ab===null){return X}for(var Z=0;Z<aa.length;Z++){if(aa[Z].search("opus/48000")!==-1){var Y=J(aa[Z],/:(\d+) opus\/48000/i);if(Y){aa[ab]=F(aa[ab],Y)}break}}aa=g(aa,ab);X=aa.join("\r\n");return X}function J(Y,Z){var X=Y.match(Z);return(X&&X.length==2)?X[1]:null}function F(Y,ab){var aa=Y.split(" ");var ac=new Array();var X=0;for(var Z=0;Z<aa.length;Z++){if(X===3){ac[X++]=ab}if(aa[Z]!==ab){ac[X++]=aa[Z]}}return ac.join(" ")}function g(Y,ac){var aa=Y[ac].split(" ");for(var X=Y.length-1;X>=0;X--){var ab=J(Y[X],/a=rtpmap:(\d+) CN\/\d+/i);if(ab){var Z=aa.indexOf(ab);if(Z!==-1){aa.splice(Z,1)}Y.splice(X,1)}}Y[ac]=aa.join(" ");return Y}var D=new event("open");var z=new event("close");var B=new event("onsgcmediastart");var E=new event("onsgcmediaerror");var a=new event("onsgcmediastop");var y=new event("onsgcsessionconnecting");var c=new event("onsgcsessionopen");var e=new event("onsgcsessionclose");var O=new event("onsgcaddstream");var T=new event("onsgcremovestream");var W=new event("onsgcmessage");var M=new event("onsgcsubscribe");var f=new event("onsgcunsubscribe");this.on("open",function(X){D.fire({name:"onopen",message:""});card=document.getElementById("card");n=document.getElementById("remoteVideo");navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL;navigator.getUserMedia({audio:true,video:true},function(Y){B.fire({name:"onsgcmediastart",message:"",stream:Y});K=Y;q();w.addStream(K)},function(Y){E.fire({name:"onsgcmediaerror",code:Y.code,message:""})})});this.on("close",function(X){a.fire({name:"onsgcmediastop",message:""});z.fire({name:"onclose",message:"",code:X.code,reason:X.reason,clean:X.wasClean});w.close();w=null});this.on("message",function(Z){var X=Z.message;obj=JSON.parse(X);if(obj.method=="sgc@subscribe"){if(obj.params.message=="2"){j()}M.fire({name:"onsgcsubscribe",channel:obj.params.channel,users:obj.params.message})}else{if(obj.method=="sgc@unsubscribe"){f.fire({name:"onsgcunsubscribe",channel:obj.channel,guid:obj.guid})}else{if(obj.method=="sgc@webrtc"){var Y=JSON.stringify(obj.webrtc);Y=Y.toString();k(Y)}else{W.fire({name:"onsgcmessage",method:obj.result.method,channel:obj.result.channel,message:obj.result.message,guid:obj.guid})}}}});var L=this.on;this.on=function(X,Y){if(X=="sgcmessage"){W.subscribe(Y)}else{if(X=="sgcsubscribe"){M.subscribe(Y)}else{if(X=="sgcunsubscribe"){f.subscribe(Y)}else{if(X=="open"){D.subscribe(Y)}else{if(X=="close"){z.subscribe(Y)}else{if(X=="sgcmediastart"){B.subscribe(Y)}else{if(X=="sgcmediastop"){a.subscribe(Y)}else{if(X=="sgcmediaerror"){E.subscribe(Y)}else{if(X=="sgcsessionconnecting"){y.subscribe(Y)}else{if(X=="sgcsessionopen"){c.subscribe(Y)}else{if(X=="sgcsessionclose"){e.subscribe(Y)}else{if(X=="sgcaddstream"){O.subscribe(Y)}else{if(X=="sgcremovestream"){T.subscribe(Y)}else{L.apply(this,arguments)}}}}}}}}}}}}}}}sgcws_webrtc.prototype=new sgcWebSocket();sgcws_webrtc.prototype.constructor=sgcws_webrtc;